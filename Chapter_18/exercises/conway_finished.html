<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>ID Based Conway</title>
    </head>
    <body>
        <button>Start</button>
        <table id="grid">
        </table>

        <script>
            const height = 20, width = 20;
            class Vec {
                constructor(y, x) {
                    this.y = y;
                    this.x = x;
                }
                plus(other) {
                    return new Vec(this.y + other.y, this.x + other.x);
                }
            }

            class Box {
                constructor(id) {
                    this.id = id;
                    this.checked = true;
                    this.coords = new Vec(Math.floor(this.id / height), this.id % width);
                    this.neighbors = [];

                }
                populateNeighbors() {
                    for (let dY = -1; dY <= 1; dY++) {
                        for (let dX = -1; dX <= 1; dX++) {
                            if(dY != 0 || dX != 0){
                                let displacement = new Vec(dY, dX);
                                let neighbor = this.coords.plus(displacement);
                                if (neighbor.y >= 0 && neighbor.y < height && neighbor.x >= 0 && neighbor.x < width){
                                    let neighborId = (neighbor.y * width) + neighbor.x;
                                    this.neighbors.push(neighborId);
                                }
                            }
                            
                        }
                    }
                }
                countNeighbors() {
                    let count = 0;
                    for (let id of this.neighbors) {
                        if(boxes[id].checked) count++;
                    }
                    return count;
                }
            }
            let boxes = [];
            let table = document.querySelector("#grid");
            function drawGrid() {
                for (let y = 0 ; y < height; y++) {
                    let row = document.createElement("tr");
                    for (let x = 0; x < width; x++) {
                        let cell = document.createElement("td");
                        let box = new Box (boxes.length);
                        box.checked = Math.floor((10 * Math.random())) % 2 == 0;
                        boxes.push(box);
                        let checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.checked = box.checked;
                        checkbox.id = "data-" + box.id;
                        checkbox.addEventListener("change", () => {
                            boxes[Number(checkbox.id.slice(5))].checked = checkbox.checked;
                        });
                        cell.appendChild(checkbox);
                        row.appendChild(cell);
                    }
                    table.appendChild(row);
                }
            }
            
            drawGrid();
            boxes.forEach(box => box.populateNeighbors());

            function updateGrid() {
                for (box of boxes) {
                    let checkbox = document.querySelector(`#data-${box.id}`);
                    checkbox.checked = box.checked;
                }
            }

            let button = document.querySelector("button");
            button.addEventListener("click", () => {
                requestAnimationFrame(animate);
            });
            
            function applyRules() {
                let tempBoxes = [];
                for (let box of boxes) {
                    let tempBox = new Box(box.id);
                    tempBox.neighbors = box.neighbors;
                    tempBox.checked = box.checked;
                    if(box.countNeighbors() < 2 ) {
                        tempBox.checkbox = false;
                    } else if (box.countNeighbors() > 3) {
                        tempBox.checked = false;
                    } else if (box.countNeighbors() === 3) {
                        tempBox.checked = true;
                    }
                    tempBoxes.push(tempBox);
                }
                boxes = tempBoxes;
            }
            
            function animate(time, lastTime) {
                if (lastTime != null) {
                    applyRules();
                    updateGrid();
                }
                setTimeout(() => {
                    requestAnimationFrame(newTime => animate(newTime, time));
                }, 200);
                
            }
            
            
        </script>
    </body>
</html>